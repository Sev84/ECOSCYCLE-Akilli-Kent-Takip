<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECOSCYCLE - Akıllı Kontrol Paneli</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Source+Code+Pro:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        :root {
            --primary-color: #2ecc71;
            --secondary-color: #3498db;
            --dark-bg: #073B4C;
            --card-bg: rgba(17, 47, 65, 0.7);
            --text-color: #f1f1f1;
            --nav-text-color: #f1f1f1;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.2);
            --warning-color: #f39c12;
            --critical-color: #e74c3c;
            --info-color-blue: #3498db;
        }
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body, html {
            margin: 0; padding: 0; font-family: 'Poppins', sans-serif; height: 100%;
            overflow-y: scroll;
            overflow-x: hidden; color: var(--text-color); 
            background-color: var(--dark-bg);
            background-image: linear-gradient(rgba(7, 59, 76, 0.8), rgba(7, 59, 76, 0.9)), url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=2070&auto=format&fit=crop');
            background-attachment: fixed;
            background-size: cover;
        }
        .main-container { display: flex; flex-direction: column; min-height: 100vh; }
        .top-nav { display: flex; align-items: center; padding: 0 20px; background-color: rgba(17, 47, 65, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; box-shadow: 0 2px 10px var(--shadow-color); }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container .logo-placeholder { width: 40px; height: 40px; }
        .logo-container h1 { font-size: 1.4em; margin: 0; color: var(--nav-text-color); }
        .nav-tabs { margin: 0 auto; overflow-x: auto; white-space: nowrap;}
        .nav-tabs .nav-link { background: none; border: none; color: var(--nav-text-color); padding: 20px 25px; font-size: 1em; cursor: pointer; text-decoration: none; position: relative; transition: color 0.3s, opacity 0.3s; opacity: 0.7; display: inline-block; }
        .nav-tabs .nav-link::after { content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 3px; background-color: var(--primary-color); transition: all 0.3s ease-in-out; transform: translateX(-50%);}
        .nav-tabs .nav-link.active, .nav-tabs .nav-link:hover { color: white; opacity: 1; }
        .nav-tabs .nav-link.active::after { width: 100%; left: 0; transform: translateX(0); }
        .top-nav-actions { display: flex; align-items: center; gap: 20px; }
        .action-btn { background: none; border: none; color: var(--nav-text-color); font-size: 1.2em; cursor: pointer; transition: color 0.3s; opacity: 0.8; }
        .action-btn:hover { color: var(--primary-color); opacity: 1; }
        .content-area { padding: 30px; padding-top: 100px; }
        .content-section { padding: 50px 0; display: flex; flex-direction: column; justify-content: center; min-height: 80vh; }
        .section-title { font-size: 2.5em; color: var(--primary-color); text-align: center; margin-bottom: 40px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; }
        .card { background-color: var(--card-bg); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px var(--shadow-color); backdrop-filter: blur(10px); border: 1px solid var(--border-color); transition: transform 0.3s, box-shadow 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; font-size: 1.2em; font-weight: 600; }
        .card-header .title { display: flex; align-items: center; }
        .card-header .title i { margin-right: 15px; width: 25px; text-align: center; color: var(--primary-color); }
        .sensor-value { font-size: 2.5em; font-weight: 700; text-align: center; }
        .sensor-value .unit { font-size: 0.5em; font-weight: 400; margin-left: 5px; }
        .chart-container { position: relative; height: 120px; margin-top: 20px; }
        .status-card { display: flex; align-items: center; gap: 20px;}
        .status-card i { font-size: 2.5em; transition: color 0.5s; flex-shrink: 0; }
        .status-card p { margin: 0; font-size: 1.1em; }
        .status-ok { color: var(--primary-color); }
        .status-warn { color: var(--warning-color); }
        .status-crit { color: var(--critical-color); }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .stats-table td:last-child { font-weight: 600; color: var(--primary-color); text-align: right;}
        .weather-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .weather-table td:first-child { text-align: left; font-weight: 500; }
        .weather-table i { font-size: 1.5em; margin-bottom: 5px; display: block;}
        .api-note { font-size: 0.8em; text-align: center; margin-top: 15px; opacity: 0.7; }
        .diagnostic-card { padding: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 30px; text-align: center; }
        .diagnostic-card h3 { margin-top: 0; color: var(--primary-color); }
        .system-log { background: #000; padding: 10px; border-radius: 5px; text-align: left; white-space: pre-wrap; word-wrap: break-word; max-height: 250px; overflow-y: auto; font-family: 'Source Code Pro', monospace; font-size: 0.9em; }
        .system-log .log-entry { margin-bottom: 5px; }
        .system-log .log-time { color: var(--secondary-color); margin-right: 10px; }
        .intro-text { text-align: center; max-width: 800px; margin: 0 auto 40px auto; line-height: 1.7; opacity: 0.9; }
        .feature-card { text-align: center; }
        .feature-card i { font-size: 3em; margin-bottom: 15px; color: var(--primary-color); }
        .feature-card h4 { margin-bottom: 10px; font-size: 1.2em; }
        .feature-card p { font-size: 0.95em; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="top-nav">
            <div class="logo-container">
                <img class="logo-placeholder" src="https://placehold.co/60x60/073B4C/2ecc71?text=E" alt="ECOSCYCLE Logo">
                <h1>ECOSCYCLE</h1>
            </div>
            <nav class="nav-tabs">
                <a href="#overview" class="nav-link">Genel Bakış</a>
                <a href="#status" class="nav-link">Sistem Durumu</a>
                <a href="#stats" class="nav-link">İstatistikler</a>
                <a href="#graphs" class="nav-link">Anlık Grafikler</a>
                <a href="#weather" class="nav-link">Hava Durumu</a>
                <a href="#terminal" class="nav-link">Terminal</a>
            </nav>
            <div class="top-nav-actions">
                <button id="music-toggle-btn" class="action-btn" title="Müziği Aç/Kapat"><i class="fas fa-volume-off"></i></button>
            </div>
        </header>

        <main class="content-area">
            <section id="overview" class="content-section">
                <div style="width: 100%; max-width: 1200px; margin: 0 auto;">
                    <h2 class="section-title">Akıllı Şehirler İçin Ekolojik Altyapı</h2>
                    <p class="intro-text">
                        ECOSCYCLE, şehirlerimizi iklim değişikliğinin etkilerine karşı daha dirençli hale getirmeyi amaçlayan, sensör verileriyle yönetilen akıllı bir yeşil altyapı projesidir. Sistem, yağmur suyunu toplayıp arıtarak ve hava kalitesini biyolojik olarak iyileştirerek sürdürülebilir bir kentsel çevre oluşturur.
                    </p>
                    <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="card feature-card">
                            <i class="fas fa-recycle"></i>
                            <h4>Akıllı Su Yönetimi</h4>
                            <p>Yağmur suyunu toplar, filtreler ve toprak nemi sensörlerine göre bitkilerin sulanmasında kullanarak su israfını önler.</p>
                        </div>
                        <div class="card feature-card">
                            <i class="fas fa-leaf"></i>
                            <h4>Biyolojik Hava Arıtma</h4>
                            <p>Mikroalg reaktörleri ile havadaki CO2'yi emer ve oksijen üreterek şehirlerdeki hava kalitesini doğal yollarla artırır.</p>
                        </div>
                        <div class="card feature-card">
                            <i class="fas fa-chart-pie"></i>
                            <h4>Canlı Veri Analizi</h4>
                            <p>Tüm sistem, anlık olarak toplanan sensör verileriyle izlenir, analiz edilir ve bu panel üzerinden şeffaf bir şekilde sunulur.</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="status" class="content-section">
                <div style="width: 100%; max-width: 1200px; margin: 0 auto;">
                    <h2 class="section-title">Anlık Sistem Durumu</h2>
                    <div class="grid-container" style="grid-template-columns: 1fr 1fr;">
                        <div class="card">
                            <div class="card-header"><div class="title"><i class="fas fa-water"></i><span>Su ve Toprak Durumu</span></div></div>
                            <div class="status-card">
                                <i id="water-status-icon" class="fas fa-question-circle"></i>
                                <p id="water-status-text">Veri bekleniyor...</p>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><div class="title"><i class="fas fa-leaf"></i><span>Hava ve Biyoreaktör Durumu</span></div></div>
                            <div class="status-card">
                                <i id="air-status-icon" class="fas fa-question-circle"></i>
                                <p id="air-status-text">Veri bekleniyor...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="stats" class="content-section">
                 <div style="width: 100%; max-width: 1200px; margin: 0 auto;">
                    <h2 class="section-title">Canlı Verimlilik İstatistikleri</h2>
                    <div class="grid-container" style="grid-template-columns: 1fr 1fr;">
                        <div class="card">
                            <div class="card-header"><div class="title"><i class="fas fa-seedling"></i><span>Çevresel Etki</span></div></div>
                            <table class="stats-table">
                                <tbody>
                                    <tr><td>Toplam Toplanan Su</td><td id="stats-water-collected">-- L</td></tr>
                                    <tr><td>Anlık Filtrasyon Oranı</td><td id="stats-filter-rate">-- %</td></tr>
                                    <tr><td>Toplam Azaltılan CO2</td><td id="stats-co2-reduced">-- kg</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="card">
                            <div class="card-header"><div class="title"><i class="fas fa-chart-line"></i><span>Uygulama Kullanımı</span></div></div>
                            <table class="stats-table">
                                <tbody>
                                    <tr><td>Aktif Kullanıcı (Tahmini)</td><td id="stats-daily-users">--</td></tr>
                                    <tr><td>Oturum Süresi (Tahmini)</td><td id="stats-session-time">-- dk</td></tr>
                                    <tr><td>Popüler Sekme (Tahmini)</td><td id="stats-popular-tab">--</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="graphs" class="content-section">
                <div style="width: 100%; max-width: 1400px; margin: 0 auto;">
                    <h2 class="section-title">Anlık Sensör Grafikleri</h2>
                    <div class="grid-container">
                        <div class="card"><div class="card-header"><div class="title"><i class="fas fa-sun"></i><span>Işık Şiddeti</span></div></div><div class="card-body"><div class="sensor-value" id="light-value">--</div><div class="chart-container"><canvas id="light-chart"></canvas></div></div></div>
                        <div class="card"><div class="card-header"><div class="title"><i class="fas fa-mountain-sun"></i><span>Toprak Nemi</span></div></div><div class="card-body"><div class="sensor-value" id="soil-value">--</div><div class="chart-container"><canvas id="soil-chart"></canvas></div></div></div>
                        <div class="card"><div class="card-header"><div class="title"><i class="fas fa-thermometer-half"></i><span>Sıcaklık</span></div></div><div class="card-body"><div class="sensor-value" id="temperature-value">--</div><div class="chart-container"><canvas id="temperature-chart"></canvas></div></div></div>
                        <div class="card"><div class="card-header"><div class="title"><i class="fas fa-wind"></i><span>Hava Kalitesi</span></div></div><div class="card-body"><div class="sensor-value" id="air-quality-value">--</div><div class="chart-container"><canvas id="air-quality-chart"></canvas></div></div></div>
                        <div class="card"><div class="card-header"><div class="title"><i class="fas fa-cloud-rain"></i><span>Yağmur</span></div></div><div class="card-body"><div class="sensor-value" id="rain-value">--</div></div></div>
                        <div class="card"><div class="card-header"><div class="title"><i class="fas fa-vial"></i><span>TDS</span></div></div><div class="card-body"><div class="sensor-value" id="tds-value">--</div></div></div>
                    </div>
                </div>
            </section>
            
            <section id="weather" class="content-section">
                <div style="width: 100%; max-width: 1000px; margin: 0 auto;">
                    <h2 class="section-title">Türkiye Canlı Hava Durumu</h2>
                    <div class="card">
                        <table class="weather-table" id="weather-table">
                            <thead><tr><th style="padding:15px; text-align:left;">Şehir</th><th>Durum</th><th>Sıcaklık</th><th>Nem</th><th>Rüzgar</th></tr></thead>
                            <tbody><tr><td colspan="5">Veriler yükleniyor...</td></tr></tbody>
                        </table>
                        <p class="api-note">Hava durumu verileri wttr.in tarafından sağlanmaktadır.</p>
                    </div>
                </div>
            </section>
            
            <section id="terminal" class="content-section">
                <div style="width: 100%; max-width: 1200px; margin: 0 auto;">
                    <h2 class="section-title">Terminal ve Sistem Günlüğü</h2>
                     <div class="diagnostic-card">
                        <h3><i class="fas fa-satellite-dish"></i> Bağlantı Durumu</h3>
                        <p id="connection-status-terminal">Sistem başlatılıyor...</p>
                        <h3><i class="fas fa-history"></i> Sistem Günlüğü</h3>
                        <div class="system-log" id="system-log-output-terminal"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const state = {
            db: null, auth: null, unsubscribe: null, simulationInterval: null,
            totalWaterCollected: 125.5, totalCo2Reduced: 5.2, lastUpdateTime: Date.now(),
            charts: {}, hasReceivedRealData: false, musicPlayer: null, isMusicPlaying: false
        };

        const DOMElements = {
            statusEl: document.getElementById('connection-status'),
            statusElTerminal: document.getElementById('connection-status-terminal'),
            logOutput: document.getElementById('system-log-output'),
            logOutputTerminal: document.getElementById('system-log-output-terminal'),
            navLinks: document.querySelectorAll('.nav-link'),
            weatherTableBody: document.querySelector('#weather-table tbody'),
            musicBtn: document.getElementById('music-toggle-btn'),
        };

        document.addEventListener('DOMContentLoaded', main);

        function main() {
            logEvent('Arayüz başlatılıyor...');
            initializeFirebase();
            initializeNavigation();
            initializeCharts();
            initializeMusic();
            updateUsageStats();
            setInterval(updateUsageStats, 15000);
        }

        function initializeFirebase() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'ecoscycle-default';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (!firebaseConfig) {
                handleConnectionError('Firebase yapılandırması eksik.');
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                state.auth = getAuth(app);
                state.db = getFirestore(app);
                logEvent('Firebase SDK başlatıldı.');
                onAuthStateChanged(state.auth, user => {
                    if (user) {
                        logEvent(`Kimlik doğrulandı: ${user.isAnonymous ? 'Anonim' : 'Kullanıcı'}`);
                        initializeAppLogic();
                    } else {
                        logEvent('Kimlik doğrulanıyor...');
                        signInAnonymously(state.auth).catch(() => {
                            if (initialAuthToken) signInWithCustomToken(state.auth, initialAuthToken);
                        });
                    }
                });
            } catch (e) {
                handleConnectionError(`Firebase başlatılamadı: ${e.message}`);
            }
        }

        function initializeAppLogic() {
            updateConnectionStatus('Firebase\'e bağlanıldı. Cihaz verisi bekleniyor...', 'info');
            startRealtimeListener();
            updateWeatherTable();
            setTimeout(() => {
                if (!state.hasReceivedRealData) {
                    handleConnectionError('Gerçek veri alınamadı. Simülasyon başlatılıyor.');
                }
            }, 5000);
        }

        function startRealtimeListener() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'ecoscycle-default';
            const docPath = `/artifacts/${appId}/public/data/device/live`;
            logEvent(`Veri dinleyicisi başlatıldı: ${docPath}`);
            state.unsubscribe = onSnapshot(doc(state.db, docPath), (docSnap) => {
                if (!state.hasReceivedRealData) {
                    logEvent('İlk canlı veri paketi başarıyla alındı!');
                    state.hasReceivedRealData = true;
                    if (state.simulationInterval) {
                        clearInterval(state.simulationInterval);
                        state.simulationInterval = null;
                        logEvent('Simülasyon durduruldu, canlı veriye geçildi.');
                    }
                }
                if (docSnap.exists()) {
                    updateConnectionStatus('Canlı veri alınıyor...', 'ok');
                    updateUI(docSnap.data());
                } else {
                    handleConnectionError('Cihaz veri yolu bulunamadı.');
                }
            }, (error) => {
                handleConnectionError(`Veri dinleme hatası: ${error.message}`);
            });
        }
        
        function handleConnectionError(errorMessage) {
            logEvent(errorMessage, 'error');
            updateConnectionStatus(errorMessage, 'error');
            if (!state.simulationInterval) startSimulation();
        }

        function startSimulation() {
            if (state.simulationInterval) return;
            if (state.unsubscribe) state.unsubscribe();
            logEvent('Simülasyon modu başlatıldı.', 'warn');
            const run = () => {
                const simulatedData = {
                    light: Math.floor(Math.random() * 4095), soil: Math.floor(Math.random() * 4095),
                    temperature: (15 + Math.random() * 15).toFixed(1), humidity: (30 + Math.random() * 60).toFixed(1),
                    airQuality: 300 + Math.floor(Math.random() * 1000), tds: 50 + Math.floor(Math.random() * 200),
                    rain: Math.floor(1000 + Math.random() * 3095)
                };
                updateConnectionStatus('Simülasyon Modu Aktif', 'warn');
                updateUI(simulatedData);
            };
            run();
            state.simulationInterval = setInterval(run, 2000);
        }

        function initializeNavigation() {
            DOMElements.navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href');
                    const target = document.querySelector(targetId);
                    if (target) {
                        DOMElements.navLinks.forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
            document.querySelector('.nav-link[href="#overview"]')?.classList.add('active');
        }

        function updateUI(data) {
            const now = new Date().toLocaleTimeString('tr-TR');
            const updateText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = value;
            };

            const lightPercent = convertToPercentage(data.light);
            const soilPercent = convertToPercentage(data.soil, true);
            const temp = parseFloat(data.temperature).toFixed(1);
            const airQuality = parseInt(data.airQuality);
            const tds = parseInt(data.tds);
            const rainStatus = getRainStatus(data.rain);

            updateText('light-value', `${lightPercent}<span class="unit">%</span>`);
            updateText('soil-value', `${soilPercent}<span class="unit">%</span>`);
            updateText('temperature-value', `${temp}<span class="unit">°C</span>`);
            updateText('air-quality-value', `${airQuality}<span class="unit">PPM</span>`);
            updateText('tds-value', `${tds}<span class="unit">ppm</span>`);
            updateText('rain-value', rainStatus);
            updateText('rain-garden-volume', `${(soilPercent * 0.5).toFixed(1)} L`);
            updateText('microalgae-volume', `1.0 L`);

            Object.keys(state.charts).forEach(key => {
                const chartDataMap = { light: lightPercent, soil: soilPercent, temperature: temp, airQuality: airQuality };
                updateChart(state.charts[key], now, chartDataMap[key]);
            });
            
            updateDynamicStats(data);
            updateStatusCards(soilPercent, airQuality);
        }

        function updateDynamicStats(data) {
            const timeDiff = (Date.now() - state.lastUpdateTime) / 1000;
            if (getRainStatus(data.rain) !== "Açık") state.totalWaterCollected += 0.01 * timeDiff;
            if (data.airQuality > 800) state.totalCo2Reduced += (data.airQuality / 1000000) * timeDiff;
            state.lastUpdateTime = Date.now();
            const filterRate = Math.max(95.0, 99.8 - (data.tds / 25)).toFixed(1);

            document.getElementById('stats-water-collected').textContent = `${state.totalWaterCollected.toFixed(1)} L`;
            document.getElementById('stats-co2-reduced').textContent = `${state.totalCo2Reduced.toFixed(2)} kg`;
            document.getElementById('stats-filter-rate').textContent = `${filterRate} %`;
        }
        
        function updateStatusCards(soilPercent, airQuality) {
            const waterStatusText = document.getElementById('water-status-text');
            const waterStatusIcon = document.getElementById('water-status-icon');
            if (soilPercent < 30) {
                waterStatusText.textContent = `Toprak çok kuru (%${soilPercent}). Sulama gerekli.`;
                waterStatusIcon.className = 'fas fa-exclamation-triangle status-crit';
            } else {
                waterStatusText.textContent = `Toprak nemi ideal seviyede (%${soilPercent}).`;
                waterStatusIcon.className = 'fas fa-hand-holding-droplet status-ok';
            }
            
            const airStatusText = document.getElementById('air-status-text');
            const airStatusIcon = document.getElementById('air-status-icon');
            if (airQuality > 1500) {
                airStatusText.textContent = `Hava kalitesi düşük (${airQuality} PPM). Biyoreaktör aktif.`;
                airStatusIcon.className = 'fas fa-lungs-virus status-crit';
            } else {
                airStatusText.textContent = `Hava kalitesi iyi (${airQuality} PPM).`;
                airStatusIcon.className = 'fas fa-lungs status-ok';
            }
        }

        function updateConnectionStatus(message, type) {
            const colorMap = { ok: 'var(--primary-color)', info: 'var(--info-color-blue)', warn: 'var(--warning-color)', error: 'var(--critical-color)' };
            const color = colorMap[type] || 'var(--text-color)';
            if(DOMElements.statusEl) {
                DOMElements.statusEl.textContent = message;
                DOMElements.statusEl.style.color = color;
            }
            if(DOMElements.statusElTerminal) {
                DOMElements.statusElTerminal.textContent = message;
                DOMElements.statusElTerminal.style.color = color;
            }
        }

        function initializeCharts() {
            state.charts.light = createChart('light-chart', '#f39c12');
            state.charts.soil = createChart('soil-chart', '#8c6a4d');
            state.charts.temperature = createChart('temperature-chart', '#e74c3c');
            state.charts.airQuality = createChart('air-quality-chart', '#9b59b6');
            logEvent('Grafikler oluşturuldu.');
        }
        function createChart(ctxId, color) {
            const ctx = document.getElementById(ctxId)?.getContext('2d');
            if (!ctx) return null;
            return new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 2.5, fill: true, backgroundColor: 'rgba(44, 62, 80, 0.2)', tension: 0.4, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }
        function updateChart(chart, label, newData) {
            if (!chart || !chart.data) return;
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(newData);
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update('none');
        }
        
        async function updateWeatherTable() {
            const cities = ['Istanbul', 'Ankara', 'Izmir', 'Antalya', 'Trabzon'];
            DOMElements.weatherTableBody.innerHTML = ''; 
            logEvent('Hava durumu verileri çekiliyor...');
            const weatherIconMap = { "Sunny": 'fa-sun', "Clear": 'fa-moon', "Partly cloudy": 'fa-cloud-sun', "Cloudy": 'fa-cloud', "Overcast": 'fa-cloud', "Mist": 'fa-smog', "Patchy rain possible": 'fa-cloud-sun-rain', "Light rain": 'fa-cloud-rain', "Heavy rain": 'fa-cloud-showers-heavy' };

            for (const city of cities) {
                try {
                    const response = await fetch(`https://wttr.in/${city}?format=j1`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    const condition = data.current_condition[0];
                    const desc = condition.weatherDesc[0].value;
                    const iconKey = Object.keys(weatherIconMap).find(key => desc.includes(key)) || "Cloudy";
                    const row = `<tr><td style="text-align:left;">${data.nearest_area[0].areaName[0].value}</td><td><i class="fas ${weatherIconMap[iconKey]}"></i> ${desc}</td><td>${condition.temp_C} °C</td><td>${condition.humidity} %</td><td>${(condition.windspeedKmph / 3.6).toFixed(1)} m/s</td></tr>`;
                    DOMElements.weatherTableBody.innerHTML += row;
                } catch (error) {
                    DOMElements.weatherTableBody.innerHTML += `<tr><td style="text-align:left;">${city}</td><td colspan="4" style="color:var(--warning-color);">Veri alınamadı</td></tr>`;
                }
            }
            logEvent('Hava durumu tablosu güncellendi.');
        }

        function updateUsageStats() {
            document.getElementById('stats-daily-users').textContent = Math.floor(20 + Math.random() * 15);
            document.getElementById('stats-session-time').textContent = (10 + Math.random() * 5).toFixed(1) + ' dk';
            document.getElementById('stats-popular-tab').textContent = ['Grafikler', 'Durum', 'Genel Bakış'][Math.floor(Math.random()*3)];
        }
        
        function logEvent(message, type = 'info') {
            const colorMap = { info: 'var(--text-color)', warn: 'var(--warning-color)', error: 'var(--critical-color)' };
            const createLogEntry = () => `<div class="log-entry"><span class="log-time">${new Date().toLocaleTimeString()}</span> <span style="color: ${colorMap[type]}">${message}</span></div>`;
            if (DOMElements.logOutput) DOMElements.logOutput.innerHTML += createLogEntry();
            if (DOMElements.logOutputTerminal) DOMElements.logOutputTerminal.innerHTML += createLogEntry();
            if (DOMElements.logOutput) DOMElements.logOutput.scrollTop = DOMElements.logOutput.scrollHeight;
            if (DOMElements.logOutputTerminal) DOMElements.logOutputTerminal.scrollTop = DOMElements.logOutputTerminal.scrollHeight;
        }

        function initializeMusic() {
            const synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
            }).toDestination();
            const pattern = new Tone.Pattern((time, note) => {
                synth.triggerAttackRelease(note, "8n", time);
            }, ["C4", "E4", "G4", "B4"], "randomWalk");
            pattern.interval = "4n";
            state.musicPlayer = pattern;

            DOMElements.musicBtn.addEventListener('click', async () => {
                await Tone.start();
                if (state.isMusicPlaying) {
                    state.musicPlayer.stop();
                    Tone.Transport.stop();
                    DOMElements.musicBtn.innerHTML = '<i class="fas fa-volume-off"></i>';
                } else {
                    Tone.Transport.start();
                    state.musicPlayer.start(0);
                    DOMElements.musicBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                }
                state.isMusicPlaying = !state.isMusicPlaying;
            });
            logEvent('Müzik sistemi hazır.');
        }

        const convertToPercentage = (value, inverted = false) => {
            const numValue = parseInt(value, 10);
            if (isNaN(numValue)) return 0;
            return Math.round(inverted ? 100 - (numValue / 4095 * 100) : (numValue / 4095 * 100));
        };

        const getRainStatus = (value) => {
            const numValue = parseInt(value, 10);
            if (isNaN(numValue) || numValue > 3500) return "Açık";
            if (numValue > 2500) return "Çiseleme";
            return "Yağmurlu";
        };
    </script>
</body>
</html>
